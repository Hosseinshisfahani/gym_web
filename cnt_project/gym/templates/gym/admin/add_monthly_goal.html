{% extends 'gym/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}{{ page_title }} - پلتفرم جامع ورزشی{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-0"><i class="fas fa-{% if goal %}edit{% else %}plus{% endif %} me-2"></i>{{ page_title }}</h2>
            <p class="text-muted">تعریف و تنظیم اهداف ماهانه برای کاربران</p>
        </div>
        <div class="col-auto">
            <a href="{% url 'gym:monthly_goals' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right me-2"></i>بازگشت به لیست اهداف
            </a>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Form Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h4 class="mb-0 text-dark">
                        <i class="fas fa-form me-2"></i>
                        اطلاعات هدف ماهانه
                    </h4>
                </div>
                <div class="card-body bg-light">
                    <form method="post" id="goalForm">
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.user.id_for_label }}" class="form-label text-dark">
                                    <i class="fas fa-user me-1"></i>انتخاب کاربر *
                                </label>
                                {% render_field form.user class="form-select" %}
                                {% if form.user.errors %}
                                    <div class="text-danger small mt-1">{{ form.user.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.status.id_for_label }}" class="form-label text-dark">
                                    <i class="fas fa-flag me-1"></i>وضعیت
                                </label>
                                {% render_field form.status class="form-select" %}
                                {% if form.status.errors %}
                                    <div class="text-danger small mt-1">{{ form.status.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>



                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.start_date.id_for_label }}" class="form-label text-dark">
                                    <i class="fas fa-calendar-alt me-1"></i>تاریخ شروع *
                                </label>
                                {% render_field form.start_date class="form-control" type="date" %}
                                {% if form.start_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.start_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.end_date.id_for_label }}" class="form-label text-dark">
                                    <i class="fas fa-calendar-check me-1"></i>تاریخ پایان *
                                </label>
                                {% render_field form.end_date class="form-control" type="date" %}
                                {% if form.end_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.end_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>



                        <!-- Target Measurements Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-crosshairs me-2"></i>اهداف اندازه‌گیری</h6>
                            </div>
                            <div class="card-body bg-light">
                                <!-- Weight Goal -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-primary border-bottom pb-2"><i class="fas fa-weight me-2"></i>هدف وزن</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.target_weight.id_for_label }}" class="form-label text-dark">
                                            مقدار هدف
                                        </label>
                                        <div class="input-group">
                                            {% render_field form.target_weight class="form-control" %}
                                            <span class="input-group-text">کیلوگرم</span>
                                        </div>
                                        {% if form.target_weight.errors %}
                                            <div class="text-danger small mt-1">{{ form.target_weight.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.weight_goal_direction.id_for_label }}" class="form-label text-dark">
                                            نوع هدف (کاهش/افزایش/حفظ)
                                        </label>
                                        {% render_field form.weight_goal_direction class="form-select" %}
                                        {% if form.weight_goal_direction.errors %}
                                            <div class="text-danger small mt-1">{{ form.weight_goal_direction.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Body Fat Goal -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-warning border-bottom pb-2"><i class="fas fa-chart-pie me-2"></i>هدف درصد چربی بدن</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.target_body_fat_percentage.id_for_label }}" class="form-label text-dark">
                                            مقدار هدف
                                        </label>
                                        <div class="input-group">
                                            {% render_field form.target_body_fat_percentage class="form-control" %}
                                            <span class="input-group-text">%</span>
                                        </div>
                                        {% if form.target_body_fat_percentage.errors %}
                                            <div class="text-danger small mt-1">{{ form.target_body_fat_percentage.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.body_fat_goal_direction.id_for_label }}" class="form-label text-dark">
                                            نوع هدف (کاهش/افزایش/حفظ)
                                        </label>
                                        {% render_field form.body_fat_goal_direction class="form-select" %}
                                        {% if form.body_fat_goal_direction.errors %}
                                            <div class="text-danger small mt-1">{{ form.body_fat_goal_direction.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Muscle Mass Goal -->
                                <div class="row">
                                    <div class="col-12">
                                        <h6 class="text-success border-bottom pb-2"><i class="fas fa-dumbbell me-2"></i>هدف توده عضلانی</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.target_muscle_mass.id_for_label }}" class="form-label text-dark">
                                            مقدار هدف
                                        </label>
                                        <div class="input-group">
                                            {% render_field form.target_muscle_mass class="form-control" %}
                                            <span class="input-group-text">کیلوگرم</span>
                                        </div>
                                        {% if form.target_muscle_mass.errors %}
                                            <div class="text-danger small mt-1">{{ form.target_muscle_mass.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.muscle_mass_goal_direction.id_for_label }}" class="form-label text-dark">
                                            نوع هدف (کاهش/افزایش/حفظ)
                                        </label>
                                        {% render_field form.muscle_mass_goal_direction class="form-select" %}
                                        {% if form.muscle_mass_goal_direction.errors %}
                                            <div class="text-danger small mt-1">{{ form.muscle_mass_goal_direction.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>مهم:</strong> مشخص کردن نوع هدف (کاهش/افزایش/حفظ) برای محاسبه صحیح درصد پیشرفت ضروری است. 
                                    بر اساس این تنظیمات، پیشرفت ورزشکار به سمت اهداف تعیین شده محاسبه می‌شود.
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.coach_notes.id_for_label }}" class="form-label text-dark">
                                <i class="fas fa-sticky-note me-1"></i>یادداشت مربی
                            </label>
                            {% render_field form.coach_notes class="form-control" rows="3" placeholder="توصیه‌ها، راهنمایی‌ها و نکات مربی..." %}
                            {% if form.coach_notes.errors %}
                                <div class="text-danger small mt-1">{{ form.coach_notes.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'gym:monthly_goals' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>لغو
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>
                                {% if goal %}ذخیره تغییرات{% else %}ایجاد هدف{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today as default start date if adding new goal
    {% if not goal %}
    const today = new Date().toISOString().split('T')[0];
    const startDateField = document.getElementById('{{ form.start_date.id_for_label }}');
    if (startDateField && !startDateField.value) {
        startDateField.value = today;
    }
    
    // Set end date to 30 days from start date
    const endDateField = document.getElementById('{{ form.end_date.id_for_label }}');
    if (endDateField && !endDateField.value) {
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 30);
        endDateField.value = endDate.toISOString().split('T')[0];
    }
    {% endif %}

    // Calculate remaining days for existing goals
    {% if goal %}
    const endDate = new Date('{{ goal.end_date|date:"Y-m-d" }}');
    const today = new Date();
    const diffTime = endDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    const remainingElement = document.getElementById('remainingDays');
    if (diffDays > 0) {
        remainingElement.textContent = diffDays + ' روز';
        remainingElement.className = 'text-success';
    } else if (diffDays === 0) {
        remainingElement.textContent = 'امروز!';
        remainingElement.className = 'text-warning fw-bold';
    } else {
        remainingElement.textContent = 'گذشته (' + Math.abs(diffDays) + ' روز)';
        remainingElement.className = 'text-danger';
    }
    {% endif %}

    // Form validation
    document.getElementById('goalForm').addEventListener('submit', function(e) {
        const startDate = new Date(document.getElementById('{{ form.start_date.id_for_label }}').value);
        const endDate = new Date(document.getElementById('{{ form.end_date.id_for_label }}').value);
        
        if (endDate <= startDate) {
            e.preventDefault();
            alert('تاریخ پایان باید بعد از تاریخ شروع باشد.');
            return false;
        }
        
        const title = document.getElementById('{{ form.title.id_for_label }}').value.trim();
        if (title.length < 5) {
            e.preventDefault();
            alert('عنوان هدف باید حداقل ۵ کاراکتر باشد.');
            return false;
        }
    });
});
</script>

<style>
.form-label {
    font-weight: 600;
}

.card-header.bg-light h4,
.card-body.bg-light .form-label {
    color: #212529 !important;
}

.form-text {
    font-size: 0.875rem;
    color: #6c757d;
}

.input-group-text {
    background-color: #e9ecef;
    border-color: #ced4da;
}

.btn-gap {
    gap: 0.5rem;
}
</style>
{% endblock %} 