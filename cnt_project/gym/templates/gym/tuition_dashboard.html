{% extends 'gym/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}داشبورد شهریه - پلتفرم جامع ورزشی{% endblock %}

{% block content %}
<div class="container mt-4">
    {% csrf_token %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-graduation-cap text-primary me-2"></i>
                    داشبورد شهریه
                </h2>
                <div class="d-flex gap-2">
                    {% if not is_admin %}
                    <a href="{% url 'gym:upload_tuition_receipt' %}" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>
                        آپلود رسید جدید
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards - Only for regular users -->
    {% if not is_admin %}
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-receipt fa-2x mb-2"></i>
                    <h5 class="card-title">کل رسیدها</h5>
                    <h3 class="mb-0">{{ total_receipts }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h5 class="card-title">تایید شده</h5>
                    <h3 class="mb-0">{{ approved_receipts }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h5 class="card-title">در انتظار</h5>
                    <h3 class="mb-0">{{ pending_receipts }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                    <h5 class="card-title">منقضی شده</h5>
                    <h3 class="mb-0">{{ expired_receipts }}</h3>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Active Tuition Status -->
    {% if active_tuition %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        وضعیت شهریه فعال
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>نوع شهریه:</strong> {{ active_tuition.category.name }}</p>
                            <p><strong>مبلغ:</strong> {{ active_tuition.amount_paid|floatformat:0 }} تومان</p>
                            <p><strong>تاریخ پرداخت:</strong> {{ active_tuition.payment_date|persian_date:"Y/m/d" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>تاریخ انقضا:</strong> {{ active_tuition.expiry_date|persian_date:"Y/m/d" }}</p>
                            <p><strong>روزهای باقی‌مانده:</strong> 
                                <span class="badge bg-success">{{ active_tuition.days_until_expiry }} روز</span>
                            </p>
                            <p><strong>وضعیت:</strong> 
                                <span class="badge bg-success">{{ active_tuition.get_status_display }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Admin Management Section -->
    {% if is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card admin-management-card">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        بخش مدیریت شهریه
                        <span class="badge bg-light text-dark ms-2">ادمین</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Admin Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-2 col-6 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center p-3">
                                    <i class="fas fa-receipt fa-2x mb-2"></i>
                                    <h6 class="card-title">کل سیستم</h6>
                                    <h4 class="mb-0">{{ admin_total_receipts }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center p-3">
                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                    <h6 class="card-title">نیاز بررسی</h6>
                                    <h4 class="mb-0">{{ admin_pending_receipts }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center p-3">
                                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                                    <h6 class="card-title">تایید شده</h6>
                                    <h4 class="mb-0">{{ admin_approved_receipts }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center p-3">
                                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                                    <h6 class="card-title">رد شده</h6>
                                    <h4 class="mb-0">{{ admin_rejected_receipts }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="card bg-secondary text-white">
                                <div class="card-body text-center p-3">
                                    <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                    <h6 class="card-title">منقضی</h6>
                                    <h4 class="mb-0">{{ admin_expired_receipts }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="card bg-dark text-white">
                                <div class="card-body text-center p-3">
                                    <i class="fas fa-tags fa-2x mb-2"></i>
                                    <h6 class="card-title">دسته‌بندی</h6>
                                    <h4 class="mb-0">{{ all_categories.count }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-white mb-3">
                                <i class="fas fa-bolt me-2"></i>
                                دسترسی سریع
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-light" onclick="refreshAdminData()">
                                    <i class="fas fa-sync me-2"></i>
                                    به‌روزرسانی
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Receipts for Quick Review -->
                    {% if pending_for_review %}
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-white mb-3">
                                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                رسیدهای نیازمند بررسی فوری
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>ورزشکار</th>
                                            <th>دسته‌بندی</th>
                                            <th>مبلغ</th>
                                            <th>تاریخ آپلود</th>
                                            <th>عملیات سریع</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for receipt in pending_for_review %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if receipt.athlete.userprofile.profile_image %}
                                                        <img src="{{ receipt.athlete.userprofile.profile_image.url }}" 
                                                             alt="Profile" class="rounded-circle me-2" width="30" height="30">
                                                    {% else %}
                                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                             style="width: 30px; height: 30px;">
                                                            <i class="fas fa-user text-white" style="font-size: 12px;"></i>
                                                        </div>
                                                    {% endif %}
                                                    <div>
                                                        <div class="small fw-bold">{{ receipt.athlete.userprofile.name|default:"بدون نام" }}</div>
                                                        <div class="small text-muted">{{ receipt.athlete.username }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ receipt.category.name }}</span>
                                            </td>
                                            <td>{{ receipt.amount_paid|floatformat:0 }} تومان</td>
                                            <td>{{ receipt.created_at|persian_date:"m/d H:i" }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-success" onclick="quickApprove({{ receipt.id }})" title="تایید سریع">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-danger" onclick="quickReject({{ receipt.id }})" title="رد سریع">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <a href="{% url 'gym:review_tuition_receipt' receipt.id %}" class="btn btn-info" title="بررسی کامل">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if receipt.receipt_image %}
                                                    <a href="{{ receipt.receipt_image.url }}" target="_blank" class="btn btn-outline-light" title="مشاهده رسید">
                                                        <i class="fas fa-image"></i>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-success" role="alert">
                                <i class="fas fa-check-circle me-2"></i>
                                همه رسیدها بررسی شده‌اند! هیچ رسید در انتظاری وجود ندارد.
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Admin Receipt Status Checker & Payment Tracker -->
    {% if is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        بررسی وضعیت رسیدها و پیگیری پرداخت‌ها
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Filter Options -->
                    <div class="row mb-3">
                        <div class="col-md-3 mb-2">
                            <select id="statusFilter" class="form-select" onchange="filterReceipts()">
                                <option value="">همه وضعیت‌ها</option>
                                <option value="pending">در انتظار بررسی</option>
                                <option value="approved">تایید شده</option>
                                <option value="rejected">رد شده</option>
                                <option value="expired">منقضی شده</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <select id="categoryFilter" class="form-select" onchange="filterReceipts()">
                                <option value="">همه دسته‌بندی‌ها</option>
                                {% for category in all_categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <input type="text" id="userSearch" class="form-control" placeholder="جستجوی کاربر..." onkeyup="filterReceipts()">
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-outline-primary w-100" onclick="resetFilters()">
                                <i class="fas fa-redo me-2"></i>
                                بازنشانی فیلترها
                            </button>
                        </div>
                    </div>

                    <!-- Receipts Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="receiptsTable">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 18%">ورزشکار</th>
                                    <th style="width: 12%">مبلغ</th>
                                    <th style="width: 12%">تاریخ پرداخت</th>
                                    <th style="width: 12%">تاریخ انقضا</th>
                                    <th style="width: 10%">وضعیت</th>
                                    <th style="width: 13%">بررسی شده توسط</th>
                                    <th style="width: 12%">تاریخ آپلود</th>
                                    <th style="width: 6%">عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for receipt in all_receipts %}
                                <tr class="receipt-row" 
                                    data-status="{{ receipt.status }}"
                                    data-category="{{ receipt.category.id }}"
                                    data-user="{{ receipt.athlete.userprofile.name|default:receipt.athlete.username|lower }}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if receipt.athlete.userprofile.profile_image %}
                                                <img src="{{ receipt.athlete.userprofile.profile_image.url }}" 
                                                     alt="Profile" class="rounded-circle me-2" width="32" height="32">
                                            {% else %}
                                                <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                     style="width: 32px; height: 32px;">
                                                    <i class="fas fa-user text-white" style="font-size: 14px;"></i>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-bold small">{{ receipt.athlete.userprofile.name|default:"بدون نام" }}</div>
                                                <div class="text-muted" style="font-size: 0.75rem;">{{ receipt.athlete.username }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ receipt.amount_paid|floatformat:0|add_commas }}</strong>
                                        <small class="text-muted d-block">تومان</small>
                                    </td>
                                    <td>
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ receipt.payment_date|persian_date:"Y/m/d" }}
                                    </td>
                                    <td>
                                        {% if receipt.is_expired %}
                                            <span class="text-danger">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                {{ receipt.expiry_date|persian_date:"Y/m/d" }}
                                            </span>
                                        {% else %}
                                            <span class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                {{ receipt.expiry_date|persian_date:"Y/m/d" }}
                                            </span>
                                            <small class="text-muted d-block">{{ receipt.days_until_expiry }} روز</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if receipt.status == 'approved' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                {{ receipt.get_status_display }}
                                            </span>
                                        {% elif receipt.status == 'pending' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>
                                                {{ receipt.get_status_display }}
                                            </span>
                                        {% elif receipt.status == 'rejected' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times-circle me-1"></i>
                                                {{ receipt.get_status_display }}
                                            </span>
                                        {% elif receipt.status == 'expired' %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-calendar-times me-1"></i>
                                                {{ receipt.get_status_display }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if receipt.reviewed_by %}
                                            <div class="small">
                                                <i class="fas fa-user-check text-success me-1"></i>
                                                {{ receipt.reviewed_by.userprofile.name|default:receipt.reviewed_by.username }}
                                                <div class="text-muted" style="font-size: 0.7rem;">
                                                    {{ receipt.reviewed_at|persian_date:"m/d H:i" }}
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted small">
                                                <i class="fas fa-minus"></i>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <i class="fas fa-upload me-1"></i>
                                        {{ receipt.created_at|persian_date:"m/d H:i" }}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'gym:review_tuition_receipt' receipt.id %}" 
                                               class="btn btn-outline-primary" 
                                               title="بررسی کامل">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if receipt.receipt_image %}
                                            <a href="{{ receipt.receipt_image.url }}" 
                                               target="_blank" 
                                               class="btn btn-outline-info" 
                                               title="مشاهده رسید">
                                                <i class="fas fa-image"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Info -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info mb-0">
                                <div class="row text-center">
                                    <div class="col-md-2">
                                        <strong>کل رسیدها:</strong>
                                        <div class="fs-5 text-primary" id="totalCount">{{ all_receipts.count }}</div>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>نمایش داده شده:</strong>
                                        <div class="fs-5 text-dark" id="visibleCount">{{ all_receipts.count }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>مجموع مبالغ تایید شده:</strong>
                                        <div class="fs-5 text-success">
                                            {{ total_approved_amount|floatformat:0|add_commas }} تومان
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>تایید شده:</strong>
                                        <div class="fs-5 text-success" id="totalApproved">{{ admin_approved_receipts }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>در انتظار بررسی:</strong>
                                        <div class="fs-5 text-warning">
                                            {{ admin_pending_receipts }} رسید
                                            <small class="d-block text-muted">{{ total_pending_amount|floatformat:0|add_commas }} تومان</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Payment Information Section - Only for regular users -->
    {% if not is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card payment-info-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        دستورالعمل پرداخت دستی
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="text-warning mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        اطلاعات پرداخت
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="payment-details">
                                
                                <div class="payment-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="payment-label">شماره کارت:</span>
                                            <span class="payment-value" id="cardNumber">5041721067855313</span>
                                        </div>
                                        <button class="btn btn-outline-light btn-sm copy-btn" onclick="copyToClipboard('cardNumber')">
                                            <i class="fas fa-copy me-1"></i>
                                            کپی
                                        </button>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="payment-instructions">
                        <h6 class="text-warning mb-3">
                            <i class="fas fa-list-ol me-2"></i>
                            دستورالعمل پرداخت
                        </h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-arrow-left text-warning me-2"></i>
                                رسید پرداخت خود را عکس بگیرید
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-arrow-left text-warning me-2"></i>
                                تصویر رسید را در فرم زیر آپلود کنید
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-arrow-left text-warning me-2"></i>
                                پس از تایید پرداخت درخواست شما بررسی خواهد شد
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}


    <!-- Receipts List - Only for regular users -->
    {% if not is_admin %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        تاریخچه رسیدها
                    </h5>
                </div>
                <div class="card-body">
                    {% if user_receipts %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>نوع شهریه</th>
                                    <th>مبلغ</th>
                                    <th>تاریخ پرداخت</th>
                                    <th>وضعیت</th>
                                    <th>تاریخ انقضا</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for receipt in user_receipts %}
                                <tr>
                                    <td>{{ receipt.category.name }}</td>
                                    <td>{{ receipt.amount_paid|floatformat:0 }} تومان</td>
                                    <td>{{ receipt.payment_date|persian_date:"Y/m/d" }}</td>
                                    <td>
                                        {% if receipt.status == 'approved' %}
                                            <span class="badge bg-success">{{ receipt.get_status_display }}</span>
                                        {% elif receipt.status == 'pending' %}
                                            <span class="badge bg-warning">{{ receipt.get_status_display }}</span>
                                        {% elif receipt.status == 'rejected' %}
                                            <span class="badge bg-danger">{{ receipt.get_status_display }}</span>
                                        {% elif receipt.status == 'expired' %}
                                            <span class="badge bg-secondary">{{ receipt.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if receipt.is_expired %}
                                            <span class="text-danger">{{ receipt.expiry_date|persian_date:"Y/m/d" }}</span>
                                        {% else %}
                                            {{ receipt.expiry_date|persian_date:"Y/m/d" }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'gym:tuition_receipt_detail' receipt.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">هنوز هیچ رسید شهریه‌ای آپلود نکرده‌اید.</p>
                        <a href="{% url 'gym:upload_tuition_receipt' %}" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>
                            آپلود اولین رسید
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mt-4" id="specialFeesSection">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-star text-warning me-2"></i>
                        {% if is_admin %}
                            مدیریت شهریه‌های ویژه
                        {% else %}
                            شهریه‌های ویژه من
                        {% endif %}
                    </h5>
                    {% if is_admin %}
                    <button class="btn btn-success btn-sm" onclick="showCreateSpecialFeeForm()">
                        <i class="fas fa-plus me-2"></i>
                        افزودن شهریه ویژه
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="forceRefreshTable()">
                        <i class="fas fa-sync me-2"></i>
                        به‌روزرسانی جدول
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="location.reload()">
                        <i class="fas fa-refresh me-2"></i>
                        بارگذاری مجدد
                    </button>
                    {% else %}
                    <button class="btn btn-outline-light btn-sm" onclick="location.reload()">
                        <i class="fas fa-sync me-2"></i>
                        به‌روزرسانی
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if is_admin %}
                        <!-- Admin Special Fees Management -->
                        <div id="specialFeesList">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover" id="specialFeesTable">
                                    <thead>
                                        <tr>
                                            <th>کاربر</th>
                                            <th>عنوان</th>
                                            <th>مبلغ</th>
                                            <th>وضعیت</th>
                                            <th>تاریخ سررسید</th>
                                            <th>تاریخ ایجاد</th>
                                            <th>عملیات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="specialFeesTableBody">
                                        <tr id="loadingRow">
                                            <td colspan="7" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">در حال بارگذاری...</span>
                                                </div>
                                                <div class="mt-2">در حال بارگذاری شهریه‌های ویژه...</div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Create Special Fee Form (Hidden by default) -->
                        <div id="createSpecialFeeForm" style="display: none;">
                            <form id="specialFeeForm">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">کاربر</label>
                                            <select name="user" class="form-control" required>
                                                <option value="">انتخاب کاربر</option>
                                                <!-- Users will be loaded via AJAX -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">مبلغ (تومان)</label>
                                            <input type="number" name="amount" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">عنوان</label>
                                            <input type="text" name="title" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">تاریخ سررسید</label>
                                            <input type="text" name="due_date" id="due_date_persian" class="form-control" placeholder="مثال: 1403/07/15" required>
                                            <small class="form-text text-muted">تاریخ را به صورت شمسی وارد کنید (سال/ماه/روز)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">توضیحات</label>
                                    <textarea name="description" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">یادداشت‌ها</label>
                                    <textarea name="notes" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="text-center">
                                    <button type="submit" class="btn btn-success me-2">
                                        <i class="fas fa-save me-2"></i>
                                        ایجاد شهریه ویژه
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="hideCreateSpecialFeeForm()">
                                        <i class="fas fa-times me-2"></i>
                                        انصراف
                                    </button>
                                </div>
                            </form>
                        </div>
                    {% else %}
                        <!-- User Special Fees Display -->
                        {% if user_special_fees %}
                        <div class="row">
                            {% for fee in user_special_fees %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">{{ fee.title }}</h6>
                                        {% if fee.status == 'active' %}
                                            <span class="badge bg-success">{{ fee.get_status_display }}</span>
                                        {% elif fee.status == 'paid' %}
                                            <span class="badge bg-info">{{ fee.get_status_display }}</span>
                                        {% elif fee.status == 'expired' %}
                                            <span class="badge bg-danger">{{ fee.get_status_display }}</span>
                                        {% elif fee.status == 'cancelled' %}
                                            <span class="badge bg-secondary">{{ fee.get_status_display }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <small class="text-muted">مبلغ:</small>
                                                <div class="fw-bold text-primary">{{ fee.amount|floatformat:0 }} تومان</div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">تاریخ سررسید:</small>
                                                <div class="fw-bold {% if fee.is_overdue %}text-danger{% endif %}">
                                                    {{ fee.due_date|persian_date:"Y/m/d" }}
                                                </div>
                                            </div>
                                        </div>
                                        {% if fee.description %}
                                        <p class="small text-muted">{{ fee.description }}</p>
                                        {% endif %}
                                        {% if fee.is_overdue and fee.status == 'active' %}
                                        <div class="alert alert-danger alert-sm mb-0">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            سررسید گذشته!
                                        </div>
                                        {% elif fee.days_until_due <= 3 and fee.status == 'active' %}
                                        <div class="alert alert-warning alert-sm mb-0">
                                            <i class="fas fa-clock me-1"></i>
                                            تا {{ fee.days_until_due }} روز دیگر سررسید
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-star fa-3x text-muted mb-3"></i>
                            <p class="text-muted">هیچ شهریه ویژه‌ای برای شما تعریف نشده است</p>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .card {
        border: 1px solid var(--section-border-color);
        background-color: var(--secondary-color);
        color: var(--light-gray);
    }
    
    .card-header {
        background-color: var(--section-border-color);
        border-bottom: 1px solid var(--section-border-color);
    }
    
    .table {
        color: var(--light-gray);
    }
    
    .table-dark {
        background-color: var(--section-border-color);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Payment Information Section Styles */
    .payment-info-card {
        background: linear-gradient(135deg, #2c1810 0%, #3a1c1c 100%);
        border: 2px solid #ffc107;
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.2);
    }
    
    .payment-info-card .card-header {
        background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
        border-bottom: 2px solid #ffc107;
    }
    
    .payment-details {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .payment-item {
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .payment-item:last-child {
        border-bottom: none;
    }
    
    .payment-label {
        color: #ffc107;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .payment-value {
        color: white;
        font-weight: 700;
        font-family: 'Courier New', monospace;
        background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
        color: #000;
        padding: 8px 12px;
        border-radius: 6px;
        border: 2px solid #ffc107;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        font-size: 1.1rem;
        letter-spacing: 1px;
    }
    
    .copy-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        transition: all 0.3s ease;
        min-width: 80px;
    }
    
    .copy-btn:hover {
        background: #ffc107;
        border-color: #ffc107;
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }
    
    .copy-btn:active {
        transform: translateY(0);
    }
    
    .payment-instructions {
        background: rgba(255, 193, 7, 0.1);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .payment-instructions ul li {
        color: white;
        font-size: 1.1rem;
        line-height: 1.8;
        padding: 8px 0;
    }
    
    .payment-instructions ul li i {
        color: #ffc107;
        font-size: 1.2rem;
    }
    
    /* Admin Management Section Styles */
    .admin-management-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid #0d6efd;
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.3);
    }
    
    .admin-management-card .card-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        border-bottom: 2px solid #0d6efd;
    }
    
    .admin-management-card .card-body {
        background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
    }
    
    .admin-management-card .table-dark {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(13, 110, 253, 0.3);
    }
    
    .admin-management-card .table-dark th {
        background-color: rgba(13, 110, 253, 0.2);
        border-color: rgba(13, 110, 253, 0.3);
        color: #ffffff;
    }
    
    .admin-management-card .table-dark td {
        border-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }
    
    .admin-management-card .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .admin-management-card .btn-outline-light {
        border-color: rgba(255, 255, 255, 0.5);
        color: #ffffff;
        transition: all 0.3s ease;
    }
    
    .admin-management-card .btn-outline-light:hover {
        background-color: #ffffff;
        border-color: #ffffff;
        color: #16213e;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 255, 255, 0.2);
    }
    
    .admin-management-card .alert-success {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        border: 1px solid #20c997;
        color: white;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%) !important;
    }
    
    /* Quick action buttons hover effects */
    .admin-management-card .btn-group .btn {
        transition: all 0.2s ease;
    }
    
    .admin-management-card .btn-group .btn:hover {
        transform: scale(1.1);
        z-index: 2;
    }
    
    /* Toast notification styles */
    .toast-container {
        position: fixed;
        top: 80px;
        left: 20px;
        z-index: 1055;
    }
    
    .toast {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .toast-header {
        background: transparent;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    .toast-body {
        color: white;
        font-weight: 500;
    }
    
    /* Special Fees Table Styles */
    #specialFeesTable {
        background-color: var(--secondary-color);
        border: 1px solid var(--section-border-color);
    }
    
    #specialFeesTable thead th {
        background-color: var(--section-border-color);
        border-color: var(--section-border-color);
        color: var(--light-gray);
        font-weight: 600;
        text-align: center;
    }
    
    #specialFeesTable tbody td {
        border-color: rgba(255, 255, 255, 0.1);
        color: var(--light-gray);
        vertical-align: middle;
    }
    
    #specialFeesTable tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    #specialFeesTable .btn-group .btn {
        transition: all 0.2s ease;
    }
    
    #specialFeesTable .btn-group .btn:hover {
        transform: scale(1.1);
        z-index: 2;
    }
    
    .spinner-border {
        width: 2rem;
        height: 2rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Copy to clipboard functionality
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;
        
        // Create a temporary textarea element
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        
        // Select and copy the text
        textarea.select();
        textarea.setSelectionRange(0, 99999); // For mobile devices
        
        try {
            document.execCommand('copy');
            showToast('متن کپی شد!', 'success');
        } catch (err) {
            // Fallback for modern browsers
            navigator.clipboard.writeText(text).then(function() {
                showToast('متن کپی شد!', 'success');
            }).catch(function(err) {
                showToast('خطا در کپی کردن متن', 'error');
            });
        }
        
        // Clean up
        document.body.removeChild(textarea);
    }
    
    // Show toast notification
    function showToast(message, type = 'success') {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll('.toast');
        existingToasts.forEach(toast => toast.remove());
        
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
        
        toast.innerHTML = `
            <div class="toast-header ${bgClass}">
                <i class="${iconClass} me-2"></i>
                <strong class="me-auto">اطلاع</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    }
    
    // Initialize tooltips for copy buttons
    document.addEventListener('DOMContentLoaded', function() {
        const copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(button => {
            button.setAttribute('title', 'کپی کردن');
        });
        
        // Auto-load special fees for admin users
        {% if is_admin %}
        loadSpecialFees();
        {% endif %}
    });
    
    // Admin Quick Actions
    function quickApprove(receiptId) {
        if (confirm('آیا از تایید این رسید اطمینان دارید؟')) {
            updateReceiptStatus(receiptId, 'approved');
        }
    }
    
    function quickReject(receiptId) {
        if (confirm('آیا از رد این رسید اطمینان دارید؟')) {
            updateReceiptStatus(receiptId, 'rejected');
        }
    }
    
    function updateReceiptStatus(receiptId, status) {
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value || 
                         document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Generate URL using Django template tag pattern
        const quickUpdateUrl = '{% url "gym:quick_update_tuition_receipt" 0 %}'.replace('/0/', `/${receiptId}/`);
        fetch(quickUpdateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                'status': status
            })
        })
        .then(response => {
            // Check if response is not ok (401, 403, etc.)
            if (!response.ok) {
                if (response.status === 401) {
                    showToast('لطفاً ابتدا وارد سیستم شوید.', 'error');
                    setTimeout(() => {
                        window.location.href = '{% url "gym:login" %}?next=' + encodeURIComponent(window.location.pathname);
                    }, 2000);
                    throw new Error('Unauthorized');
                } else if (response.status === 403) {
                    showToast('شما دسترسی لازم برای این عملیات را ندارید.', 'error');
                    throw new Error('Forbidden');
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // Remove the row from the table
                const row = document.querySelector(`button[onclick="quick${status === 'approved' ? 'Approve' : 'Reject'}(${receiptId})"]`).closest('tr');
                if (row) {
                    row.style.transition = 'opacity 0.5s ease';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        // Update counters
                        updateAdminCounters();
                    }, 500);
                }
            } else {
                showToast(data.message || 'خطا در به‌روزرسانی وضعیت', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.message !== 'Unauthorized' && error.message !== 'Forbidden') {
                showToast('خطا در ارتباط با سرور', 'error');
            }
        });
    }
    
    function refreshAdminData() {
        showToast('در حال به‌روزرسانی...', 'success');
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
    
    function updateAdminCounters() {
        // This function can be enhanced to update counters without full page reload
        // For now, we'll just refresh the page after a short delay
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
    
    // Persian Date Formatting Function
    function formatPersianDate(dateString) {
        if (!dateString) return '';
        
        try {
            // Parse the date string (YYYY-MM-DD format)
            const date = new Date(dateString + 'T00:00:00');
            
            // Persian month names
            const persianMonths = [
                'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
                'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
            ];
            
            // More accurate Persian calendar conversion
            const gregorianYear = date.getFullYear();
            const gregorianMonth = date.getMonth() + 1;
            const gregorianDay = date.getDate();
            
            // Simple conversion (for more accuracy, you'd need a proper Persian calendar library)
            let persianYear = gregorianYear - 621;
            let persianMonth = gregorianMonth;
            let persianDay = gregorianDay;
            
            // Adjust for month differences
            if (gregorianMonth <= 3) {
                persianYear = gregorianYear - 622;
                persianMonth = gregorianMonth + 9;
            } else if (gregorianMonth <= 6) {
                persianYear = gregorianYear - 621;
                persianMonth = gregorianMonth - 3;
            } else if (gregorianMonth <= 9) {
                persianYear = gregorianYear - 621;
                persianMonth = gregorianMonth - 3;
            } else {
                persianYear = gregorianYear - 621;
                persianMonth = gregorianMonth - 3;
            }
            
            // Ensure month is within valid range
            if (persianMonth < 1) persianMonth = 12;
            if (persianMonth > 12) persianMonth = 1;
            
            return `${persianDay} ${persianMonths[persianMonth - 1]} ${persianYear}`;
        } catch (error) {
            console.error('Error formatting Persian date:', error);
            return dateString; // Return original if conversion fails
        }
    }
    
    // Special Fees Functions
    function showSpecialFeesSection() {
        document.getElementById('specialFeesSection').style.display = 'block';
        {% if is_admin %}
        // Load special fees when section is shown (admin view)
        loadSpecialFees();
        {% else %}
        // For regular users, the special fees are already loaded from the backend
        // No need to make AJAX call since data is already in the template
        {% endif %}
    }
    
    function showCreateSpecialFeeForm() {
        document.getElementById('createSpecialFeeForm').style.display = 'block';
        document.getElementById('specialFeesList').style.display = 'none';
        loadUsers();
        
        // Set today's Persian date as placeholder
        const today = new Date();
        const persianToday = formatPersianDate(today.toISOString().split('T')[0]);
        const dueDateInput = document.getElementById('due_date_persian');
        if (dueDateInput) {
            dueDateInput.placeholder = `امروز: ${persianToday}`;
        }
    }
    
    function hideCreateSpecialFeeForm() {
        document.getElementById('createSpecialFeeForm').style.display = 'none';
        document.getElementById('specialFeesList').style.display = 'block';
    }
    
    function loadUsers() {
        // Add cache-busting to ensure fresh data
        const timestamp = new Date().getTime();
        fetch(`{% url "gym:api_users" %}?t=${timestamp}`)
        .then(response => response.json())
        .then(data => {
            const select = document.querySelector('select[name="user"]');
            select.innerHTML = '<option value="">انتخاب کاربر</option>';
            
            // Filter out any users with null/empty names
            const validUsers = data.users.filter(user => {
                return user.name && 
                       user.name.trim() !== '' && 
                       user.name.trim() !== 'null' && 
                       user.name.trim() !== 'None' &&
                       user.name.trim().length > 0;
            });
            
            console.log(`Loading ${validUsers.length} valid users (filtered from ${data.users.length} total)`);
            
            validUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                // Display format: "Name (Username)" or just "Name" if username is same as name
                const displayName = user.name.trim();
                const username = user.username;
                if (username && username !== user.name) {
                    option.textContent = `${displayName} (${username})`;
                } else {
                    option.textContent = displayName;
                }
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading users:', error));
    }
    
    function loadSpecialFees() {
        console.log('loadSpecialFees() called');
        const tableBody = document.getElementById('specialFeesTableBody');
        const loadingRow = document.getElementById('loadingRow');
        
        if (!tableBody) {
            console.error('Table body not found!');
            return;
        }
        
        console.log('Found table body, loading fees...');
        
        // Show loading state
        if (loadingRow) {
            loadingRow.style.display = 'table-row';
        }
        
        // Add cache-busting parameter
        const timestamp = new Date().getTime();
        fetch(`/api/special-fees/?t=${timestamp}`)
        .then(response => {
            console.log('API response status:', response.status);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('API data received:', data);
            console.log('Number of fees in response:', data.fees ? data.fees.length : 'No fees array');
            
            // Hide loading row
            if (loadingRow) {
                loadingRow.style.display = 'none';
            }
            
            // Force clear the table first
            tableBody.innerHTML = '';
            console.log('Table body cleared');
            
            if (!data.fees || data.fees.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-star fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">هیچ شهریه ویژه‌ای یافت نشد</p>
                        </td>
                    </tr>
                `;
            } else {
                console.log('Rendering', data.fees.length, 'fees in table');
                tableBody.innerHTML = data.fees.map(fee => {
                    console.log('Rendering fee:', fee.id, fee.title);
                    const statusClass = fee.status === 'active' ? 'success' : 
                                      fee.status === 'paid' ? 'info' : 
                                      fee.status === 'expired' ? 'danger' : 'secondary';
                    
                    return `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                         style="width: 30px; height: 30px;">
                                        <i class="fas fa-user text-white" style="font-size: 12px;"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">${fee.user_name}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold">${fee.title}</div>
                            </td>
                            <td>
                                <span class="fw-bold text-primary">${fee.amount.toLocaleString()} تومان</span>
                            </td>
                            <td>
                                <span class="badge bg-${statusClass}">${fee.status_display}</span>
                            </td>
                            <td>
                                <small>${formatPersianDate(fee.due_date)}</small>
                            </td>
                            <td>
                                <small>${formatPersianDate(fee.created_at)}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" onclick="editSpecialFee(${fee.id})" title="ویرایش">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteSpecialFee(${fee.id})" title="حذف">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        })
        .catch(error => {
            console.error('Error loading special fees:', error);
            if (loadingRow) {
                loadingRow.style.display = 'none';
            }
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p class="text-danger mb-0">خطا در بارگذاری شهریه‌های ویژه: ${error.message}</p>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadSpecialFees()">
                            <i class="fas fa-redo me-2"></i>
                            تلاش مجدد
                        </button>
                        <button class="btn btn-outline-warning btn-sm mt-2 ms-2" onclick="location.reload()">
                            <i class="fas fa-refresh me-2"></i>
                            بارگذاری مجدد صفحه
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    // Persian Date Conversion Functions
    function convertPersianToGregorian(persianDate) {
        if (!persianDate) return '';
        
        try {
            // Parse Persian date (YYYY/MM/DD format)
            const parts = persianDate.split('/');
            if (parts.length !== 3) {
                throw new Error('Invalid Persian date format');
            }
            
            const persianYear = parseInt(parts[0]);
            const persianMonth = parseInt(parts[1]);
            const persianDay = parseInt(parts[2]);
            
            // Convert Persian to Gregorian (approximate)
            let gregorianYear = persianYear + 621;
            let gregorianMonth = persianMonth;
            let gregorianDay = persianDay;
            
            // Adjust for month differences
            if (persianMonth <= 3) {
                gregorianYear = persianYear + 622;
                gregorianMonth = persianMonth + 9;
            } else if (persianMonth <= 6) {
                gregorianYear = persianYear + 621;
                gregorianMonth = persianMonth - 3;
            } else if (persianMonth <= 9) {
                gregorianYear = persianYear + 621;
                gregorianMonth = persianMonth - 3;
            } else {
                gregorianYear = persianYear + 621;
                gregorianMonth = persianMonth - 3;
            }
            
            // Format as YYYY-MM-DD for backend
            return `${gregorianYear}-${String(gregorianMonth).padStart(2, '0')}-${String(gregorianDay).padStart(2, '0')}`;
        } catch (error) {
            console.error('Error converting Persian date:', error);
            return persianDate; // Return original if conversion fails
        }
    }
    
    function validatePersianDate(dateString) {
        if (!dateString) return false;
        
        // Check if it matches Persian date format (YYYY/MM/DD)
        const persianDateRegex = /^\d{4}\/\d{1,2}\/\d{1,2}$/;
        if (!persianDateRegex.test(dateString)) {
            return false;
        }
        
        const parts = dateString.split('/');
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]);
        const day = parseInt(parts[2]);
        
        // Basic validation
        if (year < 1300 || year > 1500) return false; // Reasonable Persian year range
        if (month < 1 || month > 12) return false;
        if (day < 1 || day > 31) return false;
        
        return true;
    }
    
    // Handle special fee form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('specialFeeForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get the Persian date and convert it
                const persianDate = document.getElementById('due_date_persian').value;
                
                if (!validatePersianDate(persianDate)) {
                    showToast('لطفاً تاریخ را به صورت صحیح وارد کنید (مثال: 1403/07/15)', 'error');
                    return;
                }
                
                const gregorianDate = convertPersianToGregorian(persianDate);
                console.log('Persian date:', persianDate, 'Converted to Gregorian:', gregorianDate);
                
                const formData = new FormData(form);
                formData.set('due_date', gregorianDate); // Override with converted date
                
                fetch('{% url "gym:api_create_special_fee" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('شهریه ویژه با موفقیت ایجاد شد', 'success');
                        hideCreateSpecialFeeForm();
                        loadSpecialFees(); // Refresh the table
                        form.reset();
                    } else {
                        showToast(data.message || 'خطا در ایجاد شهریه ویژه', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('خطا در ارتباط با سرور', 'error');
                });
            });
        }
    });
    
    function forceRefreshTable() {
        console.log('Force refreshing table...');
        showToast('در حال به‌روزرسانی جدول...', 'info');
        
        // Clear the table first
        const tableBody = document.getElementById('specialFeesTableBody');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">در حال بارگذاری...</td></tr>';
        }
        
        // Clear any cached data
        if ('caches' in window) {
            caches.keys().then(function(names) {
                for (let name of names) {
                    caches.delete(name);
                }
            });
        }
        
        // Try to load special fees with cache busting
        loadSpecialFees();
        
        // Fallback: If table doesn't update in 2 seconds, reload the page
        setTimeout(() => {
            if (tableBody && tableBody.innerHTML.includes('در حال بارگذاری')) {
                console.log('Table refresh failed, reloading page...');
                showToast('بارگذاری مجدد صفحه...', 'info');
                location.reload();
            }
        }, 2000);
    }
    
    function editSpecialFee(feeId) {
        // Implementation for editing special fee
        showToast('قابلیت ویرایش به زودی اضافه خواهد شد', 'info');
    }
    
    function deleteSpecialFee(feeId) {
        console.log('Delete function called with ID:', feeId);
        
        if (confirm('آیا مطمئن هستید که می‌خواهید این شهریه ویژه را حذف کنید؟')) {
            console.log('User confirmed deletion');
            
            // Show loading message
            showToast('در حال حذف...', 'info');
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (!csrfToken) {
                console.error('CSRF token not found');
                showToast('خطا: CSRF token یافت نشد', 'error');
                return;
            }
            
            // Construct the delete URL
            const deleteUrl = `/api/special-fees/${feeId}/delete/`;
            
            console.log('Attempting to delete fee ID:', feeId);
            console.log('Delete URL:', deleteUrl);
            console.log('CSRF Token found:', !!csrfToken);
            
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                console.log('Delete response headers:', response.headers);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response text:', text);
                        throw new Error(`HTTP error! status: ${response.status}, text: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Delete response data:', data);
                if (data.success) {
                    showToast('شهریه ویژه با موفقیت حذف شد', 'success');
                    
                    // Try multiple methods to refresh the table
                    console.log('Attempting to refresh table...');
                    
                    // Method 1: Reload the special fees
                    setTimeout(() => {
                        console.log('Calling loadSpecialFees()...');
                        loadSpecialFees();
                    }, 500);
                    
                    // Method 2: Fallback - reload the entire page if table doesn't refresh
                    setTimeout(() => {
                        console.log('Checking if table was refreshed...');
                        const tableBody = document.getElementById('specialFeesTableBody');
                        if (tableBody && tableBody.innerHTML.includes(feeId)) {
                            console.log('Table not refreshed, reloading page...');
                            location.reload();
                        }
                    }, 3000);
                    
                } else {
                    console.log('Delete failed:', data.message);
                    showToast(data.message || 'خطا در حذف شهریه ویژه', 'error');
                    
                    // Even if delete "failed", refresh the table in case it was actually deleted
                    // This handles cases where the fee was already deleted but frontend cache is stale
                    setTimeout(() => {
                        console.log('Refreshing table even after delete "failure"...');
                        loadSpecialFees();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                showToast('خطا در ارتباط با سرور: ' + error.message, 'error');
            });
        } else {
            console.log('User cancelled deletion');
        }
    }

    // Filter and Search Functions for Admin Receipt Status Checker
    function filterReceipts() {
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        const categoryFilter = document.getElementById('categoryFilter')?.value || '';
        const userSearch = document.getElementById('userSearch')?.value.toLowerCase() || '';
        
        const rows = document.querySelectorAll('.receipt-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status');
            const category = row.getAttribute('data-category');
            const user = row.getAttribute('data-user');
            
            let showRow = true;
            
            // Status filter
            if (statusFilter && status !== statusFilter) {
                showRow = false;
            }
            
            // Category filter
            if (categoryFilter && category !== categoryFilter) {
                showRow = false;
            }
            
            // User search
            if (userSearch && !user.includes(userSearch)) {
                showRow = false;
            }
            
            // Show/hide row
            if (showRow) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update visible count
        const visibleCountEl = document.getElementById('visibleCount');
        if (visibleCountEl) {
            visibleCountEl.textContent = visibleCount;
        }
    }

    function resetFilters() {
        // Reset all filter inputs
        const statusFilter = document.getElementById('statusFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const userSearch = document.getElementById('userSearch');
        
        if (statusFilter) statusFilter.value = '';
        if (categoryFilter) categoryFilter.value = '';
        if (userSearch) userSearch.value = '';
        
        // Show all rows
        filterReceipts();
        
        showToast('فیلترها بازنشانی شدند', 'success');
    }

    // Export table to CSV (optional enhancement)
    function exportToCSV() {
        const table = document.getElementById('receiptsTable');
        let csv = [];
        
        // Get headers
        const headers = [];
        table.querySelectorAll('thead th').forEach(th => {
            headers.push(th.textContent.trim());
        });
        csv.push(headers.join(','));
        
        // Get visible rows
        const rows = table.querySelectorAll('tbody tr.receipt-row');
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const cols = [];
                row.querySelectorAll('td').forEach((td, index) => {
                    if (index < headers.length - 1) { // Skip actions column
                        cols.push('"' + td.textContent.trim().replace(/"/g, '""') + '"');
                    }
                });
                csv.push(cols.join(','));
            }
        });
        
        // Create and download file
        const csvContent = '\ufeff' + csv.join('\n'); // Add BOM for Persian support
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'receipts_' + new Date().toISOString().split('T')[0] + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('فایل CSV دانلود شد', 'success');
    }
</script>
{% endblock %}

